#!/bin/bash

PROJECT_ROOT="$(cd "$(dirname "$0")" && pwd)"
GT_DIR="$PROJECT_ROOT/gtstore"
STATE_FILE="$GT_DIR/service_pids.txt"

if [[ ! -f "$STATE_FILE" ]]; then
    echo "No GTStore service state file found."
    exit 0
fi

PIDS=()
while IFS= read -r line; do
    if [[ -n "$line" ]]; then
        PIDS+=("$line")
    fi
done < "$STATE_FILE"

if [[ ${#PIDS[@]} -eq 0 ]]; then
    echo "State file empty."
    rm -f "$STATE_FILE"
    exit 0
fi

for ((idx=${#PIDS[@]}-1; idx>=0; --idx)); do
    pid="${PIDS[$idx]}"
    if [[ -z "$pid" ]]; then
        continue
    fi
    if kill -0 "$pid" 2>/dev/null; then
        kill "$pid" 2>/dev/null || true
    fi
done

rm -f "$STATE_FILE"
echo "GTStore service stopped."
